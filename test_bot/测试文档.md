# SpinPet SDK 交易机器人测试项目设计文档

## 项目概述

本项目是一个基于 SpinPet SDK 的自动化测试交易系统，功能包括创建代币、买入代币、卖出部分持仓的完整交易流程。采用模块化架构，支持多个独立JS脚本分工协作，通过全局状态管理实现数据共享。

## 项目目标

1. **创建代币**: 生成新的测试代币并部署到区块链
2. **买入交易**: 购买100,000个代币
3. **部分卖出**: 卖出50%的持仓（50,000个代币）
4. **状态跟踪**: 记录整个交易过程的状态和结果

## 项目架构

### 目录结构

```
test_bot/
├── README.md                    # 项目说明文档
├── 测试文档.md                  # 本文档
├── package.json                 # 项目依赖配置
├── config/
│   ├── settings.js              # 基础配置文件
│   └── networks.js              # 网络配置
├── modules/
│   ├── state.js                 # 全局状态管理器
│   ├── sdk-manager.js           # SDK实例管理器
│   ├── token-creator.js         # 代币创建模块
│   ├── buyer.js                 # 买入交易模块
│   ├── seller.js                # 卖出交易模块
│   └── utils.js                 # 通用工具函数
├── scripts/
│   ├── 1-create-token.js        # 步骤1：创建代币
│   ├── 2-buy-tokens.js          # 步骤2：买入代币
│   ├── 3-sell-tokens.js         # 步骤3：卖出部分代币
│   └── run-all.js               # 执行完整流程
└── logs/
    └── trading.log              # 交易日志
```

## 核心模块设计

### 1. 全局状态管理器 (state.js)

**功能**: 管理整个测试流程的状态数据，提供统一的数据存取接口

**主要数据结构**:
```javascript
{
  // 基础配置
  network: 'LOCALNET',           // 网络环境
  walletIndex: 0,               // 钱包索引
  
  // 代币信息
  token: {
    name: 'TestBot Token',      // 代币名称
    symbol: 'TBT',              // 代币符号
    mintAddress: null,          // 创建后的mint地址
    mintKeypair: null,          // mint密钥对（Base58编码存储）
    curveAccount: null,         // 流动池账户地址
    createdAt: null,            // 创建时间
    createTxSignature: null     // 创建交易签名
  },
  
  // 交易状态
  trading: {
    // 买入记录
    buyOrder: {
      targetAmount: '100000000000',    // 目标数量（100,000 * 10^6）
      actualAmount: null,              // 实际买入数量
      solSpent: null,                  // 花费的SOL数量
      txSignature: null,               // 交易签名
      timestamp: null,                 // 交易时间
      avgPrice: null                   // 平均价格
    },
    
    // 卖出记录
    sellOrder: {
      targetAmount: '50000000000',     // 目标数量（50,000 * 10^6）
      actualAmount: null,              // 实际卖出数量
      solReceived: null,               // 获得的SOL数量
      txSignature: null,               // 交易签名
      timestamp: null,                 // 交易时间
      avgPrice: null                   // 平均价格
    },
    
    // 余额跟踪
    balances: {
      initialSol: null,               // 初始SOL余额
      finalSol: null,                 // 最终SOL余额
      remainingTokens: null,          // 剩余代币数量
      profitLoss: null                // 盈亏计算
    }
  },
  
  // 执行状态
  execution: {
    currentStep: 'idle',              // 当前执行步骤
    completedSteps: [],               // 已完成步骤
    errors: [],                       // 错误记录
    startTime: null,                  // 开始时间
    endTime: null                     // 结束时间
  }
}
```

**主要方法**:
- `getState()`: 获取完整状态
- `setState(path, value)`: 设置状态值
- `getState(path)`: 获取特定路径的状态
- `saveToFile()`: 保存状态到文件
- `loadFromFile()`: 从文件加载状态
- `reset()`: 重置状态

### 2. SDK实例管理器 (sdk-manager.js)

**功能**: 管理SpinPet SDK实例和连接

**主要方法**:
- `initialize(network, walletIndex)`: 初始化SDK
- `getSDK()`: 获取SDK实例
- `getConnection()`: 获取连接实例
- `getWallet()`: 获取钱包实例
- `checkConnection()`: 检查连接状态

### 3. 代币创建模块 (token-creator.js)

**功能**: 处理新代币的创建和部署

**主要流程**:
1. 生成新的mint密钥对
2. 构建代币元数据（名称、符号、URI）
3. 调用SDK的token.create()方法
4. 签名并发送交易
5. 验证创建结果
6. 更新全局状态

**主要方法**:
- `createToken(tokenInfo)`: 创建代币
- `verifyTokenCreation(mintAddress)`: 验证代币创建
- `getTokenMetadata(mintAddress)`: 获取代币元数据

### 4. 买入交易模块 (buyer.js)

**功能**: 执行代币买入操作

**主要流程**:
1. 获取当前价格和流动性信息
2. 使用模拟器分析买入可行性
3. 构建买入交易
4. 执行交易并等待确认
5. 记录交易结果

**主要方法**:
- `buyTokens(mintAddress, targetAmount)`: 买入指定数量代币
- `simulateBuy(mintAddress, targetAmount)`: 模拟买入分析
- `calculateOptimalAmount(mintAddress, targetAmount)`: 计算最优买入数量

### 5. 卖出交易模块 (seller.js)

**功能**: 执行代币卖出操作

**主要流程**:
1. 检查当前持仓
2. 计算卖出数量（50%持仓）
3. 使用模拟器分析卖出可行性
4. 构建卖出交易
5. 执行交易并等待确认
6. 更新余额和状态

**主要方法**:
- `sellTokens(mintAddress, sellAmount)`: 卖出指定数量代币
- `simulateSell(mintAddress, sellAmount)`: 模拟卖出分析
- `getCurrentBalance(mintAddress)`: 获取当前代币余额

## 执行脚本设计

### 1. 创建代币脚本 (1-create-token.js)

```javascript
// 执行流程：
// 1. 初始化环境和SDK
// 2. 生成代币信息
// 3. 创建代币
// 4. 验证创建结果
// 5. 更新状态
```

### 2. 买入代币脚本 (2-buy-tokens.js)

```javascript
// 执行流程：
// 1. 加载之前状态
// 2. 检查代币是否存在
// 3. 模拟买入分析
// 4. 执行买入交易
// 5. 记录交易结果
```

### 3. 卖出代币脚本 (3-sell-tokens.js)

```javascript
// 执行流程：
// 1. 加载之前状态
// 2. 检查当前持仓
// 3. 计算卖出数量
// 4. 模拟卖出分析
// 5. 执行卖出交易
// 6. 生成最终报告
```

### 4. 完整流程脚本 (run-all.js)

```javascript
// 执行完整的三步流程：
// 1. 创建代币
// 2. 买入100,000个代币
// 3. 卖出50,000个代币
// 4. 生成详细报告
```

## 配置说明

### 基础配置 (config/settings.js)

```javascript
module.exports = {
  // 网络配置
  defaultNetwork: 'LOCALNET',
  
  // 钱包配置
  defaultWalletIndex: 0,
  
  // 代币配置
  tokenDefaults: {
    name: 'TestBot Token',
    symbol: 'TBT',
    uri: 'https://example.com/testbot-token.json'
  },
  
  // 交易配置
  trading: {
    buyAmount: '100000000000',      // 100,000 tokens (精度 10^6)
    sellPercentage: 0.5,            // 卖出50%
    maxSlippage: 0.05,              // 最大滑点5%
    maxRetries: 3,                  // 最大重试次数
    confirmationTimeout: 60000      // 确认超时时间
  },
  
  // 日志配置
  logging: {
    enabled: true,
    level: 'info',
    file: 'logs/trading.log'
  }
};
```

## 使用方法

### 单独执行步骤

```bash
# 步骤1：创建代币
node test_bot/scripts/1-create-token.js

# 步骤2：买入代币
node test_bot/scripts/2-buy-tokens.js

# 步骤3：卖出代币
node test_bot/scripts/3-sell-tokens.js
```

### 执行完整流程

```bash
# 执行完整的三步流程
node test_bot/scripts/run-all.js
```

### 查看状态

```javascript
// 在任何脚本中都可以查看当前状态
const StateManager = require('./modules/state');
const state = StateManager.getState();
console.log(JSON.stringify(state, null, 2));
```

## 错误处理

### 错误类型
1. **网络连接错误**: Solana网络连接失败
2. **钱包余额不足**: SOL余额不足以支付交易费用
3. **交易失败**: 区块链交易执行失败
4. **流动性不足**: 买卖时流动性不够
5. **状态不一致**: 步骤之间状态传递错误

### 错误恢复
- 自动重试机制
- 状态回滚功能
- 详细错误日志
- 手动恢复指导

## 监控和日志

### 交易监控
- 实时余额跟踪
- 交易状态监控
- 价格变化跟踪
- Gas费用统计

### 日志系统
- 结构化日志记录
- 多级别日志（debug, info, warn, error）
- 文件和控制台双输出
- 交易历史保存

## 扩展功能

### 未来可扩展的功能
1. **多代币支持**: 同时管理多个代币
2. **策略模式**: 支持不同的买卖策略
3. **定时执行**: 支持定时自动交易
4. **风险控制**: 止损、止盈机制
5. **报告系统**: 详细的交易分析报告
6. **GUI界面**: Web界面管理交易

### 集成建议
- 可与现有的交易系统集成
- 支持API接口调用
- 数据库存储支持
- 通知系统集成

## 安全考虑

### 私钥安全
- 使用环境变量存储敏感信息
- 私钥加密存储
- 访问权限控制

### 交易安全
- 交易前模拟验证
- 滑点保护
- 最大损失限制
- 异常情况处理

## 性能优化

### 并发处理
- 异步操作优化
- 批量交易处理
- 连接池管理

### 资源管理
- 内存使用优化
- 网络请求缓存
- 状态数据压缩

---

## 总结

这个测试项目采用模块化设计，每个功能都有独立的模块和脚本，通过全局状态管理实现数据共享。项目结构清晰，易于维护和扩展，适合用于SpinPet SDK的功能测试和交易流程验证。

通过这个项目，可以全面测试SDK的代币创建、买入、卖出等核心功能，同时为后续的交易机器人开发提供基础架构。