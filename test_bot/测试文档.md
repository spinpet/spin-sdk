# SpinPet SDK 交易机器人测试项目设计文档

## 项目概述

本项目是一个基于 SpinPet SDK 的简化测试交易系统，功能包括创建代币、买入代币、卖出部分持仓的完整交易流程。采用简单的架构，通过全局状态管理器共享数据，各个脚本直接调用SDK执行交易。

## 项目目标

1. **创建代币**: 生成新的测试代币并部署到区块链
2. **买入交易**: 购买100,000个代币
3. **部分卖出**: 卖出50%的持仓（50,000个代币）
4. **状态跟踪**: 记录整个交易过程的状态和结果

## 项目架构

### 目录结构

```
test_bot/
├── 测试文档.md                  # 本文档
├── bot-global.js                # 全局状态管理器
├── scripts/
│   ├── 1-create-token.js        # 步骤1：创建代币
│   ├── 2-buy-tokens.js          # 步骤2：买入代币
│   ├── 3-sell-tokens.js         # 步骤3：卖出部分代币
│   └── run-all.js               # 执行完整流程
└── logs/
    └── trading.log              # 交易日志
```

## 核心模块设计

### 1. 全局状态管理器 (bot-global.js)

**功能**: 管理整个测试流程的状态数据，提供统一的数据存取接口

**主要数据结构**:
```javascript
{
  // 基础配置
  network: 'LOCALNET',           // 网络环境
  walletIndex: 0,               // 钱包索引
  
  // 代币信息
  token: {
    name: 'TestBot Token',      // 代币名称
    symbol: 'TBT',              // 代币符号
    mintAddress: null,          // 创建后的mint地址
    mintKeypair: null,          // mint密钥对（Base58编码存储）
    curveAccount: null,         // 流动池账户地址
    createdAt: null,            // 创建时间
    createTxSignature: null     // 创建交易签名
  },
  
  // 交易状态
  trading: {
    // 买入记录
    buyOrder: {
      targetAmount: '100000000000',    // 目标数量（100,000 * 10^6）
      actualAmount: null,              // 实际买入数量
      solSpent: null,                  // 花费的SOL数量
      txSignature: null,               // 交易签名
      timestamp: null,                 // 交易时间
      avgPrice: null                   // 平均价格
    },
    
    // 卖出记录
    sellOrder: {
      targetAmount: '50000000000',     // 目标数量（50,000 * 10^6）
      actualAmount: null,              // 实际卖出数量
      solReceived: null,               // 获得的SOL数量
      txSignature: null,               // 交易签名
      timestamp: null,                 // 交易时间
      avgPrice: null                   // 平均价格
    },
    
    // 余额跟踪
    balances: {
      initialSol: null,               // 初始SOL余额
      finalSol: null,                 // 最终SOL余额
      remainingTokens: null,          // 剩余代币数量
      profitLoss: null                // 盈亏计算
    }
  },
  
  // 执行状态
  execution: {
    currentStep: 'idle',              // 当前执行步骤
    completedSteps: [],               // 已完成步骤
    errors: [],                       // 错误记录
    startTime: null,                  // 开始时间
    endTime: null                     // 结束时间
  }
}
```

**主要方法**:
- `getState()`: 获取完整状态
- `setState(path, value)`: 设置状态值
- `saveState()`: 保存状态到文件
- `loadState()`: 从文件加载状态
- `resetState()`: 重置状态
- `logMessage(level, message)`: 记录日志消息

## 执行脚本设计

### 1. 创建代币脚本 (scripts/1-create-token.js)

**功能**: 创建新的测试代币并部署到区块链

**执行流程**:
1. 初始化SpinPet SDK连接
2. 生成新的代币mint密钥对
3. 直接调用`sdk.token.create()`创建代币
4. 签名并发送交易到区块链
5. 验证代币创建结果
6. 将代币信息保存到`bot-global.js`

### 2. 买入代币脚本 (scripts/2-buy-tokens.js)

**功能**: 购买100,000个之前创建的代币

**执行流程**:
1. 从`bot-global.js`加载代币信息
2. 检查代币是否已创建成功
3. 使用`sdk.simulator.simulateTokenBuy()`分析买入可行性
4. 直接调用`sdk.trading.buy()`执行买入交易
5. 等待交易确认并记录结果
6. 更新全局状态中的买入记录

### 3. 卖出代币脚本 (scripts/3-sell-tokens.js)

**功能**: 卖出50%的代币持仓（50,000个代币）

**执行流程**:
1. 从`bot-global.js`加载之前的交易状态
2. 检查当前代币余额
3. 计算卖出数量（买入数量的50%）
4. 使用`sdk.simulator.simulateTokenSell()`分析卖出可行性
5. 直接调用`sdk.trading.sell()`执行卖出交易
6. 生成最终的交易报告和盈亏分析

### 4. 完整流程脚本 (scripts/run-all.js)

**功能**: 按顺序执行完整的三步交易流程

**执行流程**:
1. 执行创建代币脚本
2. 执行买入代币脚本  
3. 执行卖出代币脚本
4. 生成完整的交易报告

## 配置说明

### bot-global.js 的工作原理

`bot-global.js` 包含两部分：

1. **配置部分**：用户手动配置的参数
2. **状态部分**：脚本执行后自动填充的结果数据

```javascript
// ========== 用户配置区域 ==========
const CONFIG = {
  // 网络配置
  network: 'LOCALNET',
  walletIndex: 0,
  
  // 代币配置
  tokenInfo: {
    name: 'TestBot Token',
    symbol: 'TBT', 
    uri: 'https://example.com/testbot-token.json'
  },
  
  // 交易配置
  buyAmount: '100000000000',      // 100,000 tokens (精度 10^6)
  sellPercentage: 0.5,            // 卖出50%
  
  // 执行顺序配置（可自定义）
  executionPlan: [
    { step: 'create-token', enabled: true, description: '创建代币' },
    { step: 'buy-tokens', enabled: true, description: '买入代币' },
    { step: 'sell-tokens', enabled: true, description: '卖出50%代币' }
  ],
  
  // 日志配置
  logFile: 'logs/trading.log'
};

// ========== 自动填充的状态数据 ==========
let STATE = {
  // 这部分由脚本执行后自动填充
  // 用户不需要手动配置
};
```

### 执行流程说明

**不是自动执行**，需要手动运行命令：

1. **配置阶段**：用户在 `bot-global.js` 中配置参数
2. **执行阶段**：运行脚本，脚本读取配置并执行交易
3. **状态更新**：脚本将执行结果写回 `bot-global.js` 的状态部分

## 使用方法

### 第一步：配置参数

在 `bot-global.js` 中配置你的测试参数：

```javascript
// 修改 CONFIG 部分的参数
const CONFIG = {
  network: 'LOCALNET',           // 选择网络
  walletIndex: 0,                // 选择钱包
  tokenInfo: {
    name: 'My Test Token',       // 自定义代币名称
    symbol: 'MTT',               // 自定义代币符号
    uri: 'https://example.com/metadata.json'
  },
  buyAmount: '50000000000',      // 修改买入数量（50,000个代币）
  sellPercentage: 0.3,           // 修改卖出比例（30%）
  
  // 自定义执行顺序
  executionPlan: [
    { step: 'create-token', enabled: true, description: '创建代币' },
    { step: 'buy-tokens', enabled: true, description: '买入代币' },
    { step: 'sell-tokens', enabled: false, description: '暂时跳过卖出' }  // 可以禁用某些步骤
  ]
};
```

### 第二步：执行命令

#### 单独执行步骤

```bash
# 步骤1：创建代币
node test_bot/scripts/1-create-token.js

# 步骤2：买入代币  
node test_bot/scripts/2-buy-tokens.js

# 步骤3：卖出代币
node test_bot/scripts/3-sell-tokens.js
```

#### 根据配置执行完整流程

```bash
# 按照 executionPlan 配置自动执行（跳过disabled的步骤）
node test_bot/scripts/run-all.js
```

#### 自定义执行顺序示例

```javascript
// 在 bot-global.js 中可以这样配置不同的执行计划：

// 计划1：完整流程
executionPlan: [
  { step: 'create-token', enabled: true },
  { step: 'buy-tokens', enabled: true },
  { step: 'sell-tokens', enabled: true }
]

// 计划2：只创建和买入
executionPlan: [
  { step: 'create-token', enabled: true },
  { step: 'buy-tokens', enabled: true },
  { step: 'sell-tokens', enabled: false }
]

// 计划3：跳过创建（使用已有代币）
executionPlan: [
  { step: 'create-token', enabled: false },
  { step: 'buy-tokens', enabled: true },
  { step: 'sell-tokens', enabled: true }
]
```

### 第三步：查看结果

```javascript
// 执行后查看状态
const BotGlobal = require('../bot-global');
const state = BotGlobal.getState();
console.log('交易结果:', JSON.stringify(state, null, 2));
```

## 错误处理

### 错误类型
1. **网络连接错误**: Solana网络连接失败
2. **钱包余额不足**: SOL余额不足以支付交易费用
3. **交易失败**: 区块链交易执行失败
4. **流动性不足**: 买卖时流动性不够
5. **状态不一致**: 步骤之间状态传递错误

### 错误恢复
- 自动重试机制
- 状态回滚功能
- 详细错误日志
- 手动恢复指导

## 监控和日志

### 交易监控
- 实时余额跟踪
- 交易状态监控
- 价格变化跟踪
- Gas费用统计

### 日志系统
- 结构化日志记录
- 多级别日志（debug, info, warn, error）
- 文件和控制台双输出
- 交易历史保存

## 扩展功能

## 总结

这个简化的测试项目采用"配置驱动"的设计：

### 工作原理
1. **配置阶段**: 用户在 `bot-global.js` 中配置测试参数（代币信息、交易数量、执行顺序等）
2. **执行阶段**: 手动运行脚本命令，脚本读取配置并调用SpinPet SDK执行交易
3. **状态更新**: 脚本自动将执行结果（交易签名、余额等）写回 `bot-global.js`
4. **结果查看**: 所有交易数据和状态都保存在 `bot-global.js` 中，可随时查看

### 核心特点
1. **简单结构**: 只有全局状态管理器和4个脚本文件
2. **配置驱动**: 通过修改配置控制测试行为，无需修改代码
3. **执行顺序可控**: 可自定义哪些步骤执行、哪些跳过
4. **状态持久化**: 测试数据自动保存，支持断点续执行
5. **直接调用**: 脚本直接调用SpinPet SDK，无额外封装

### 适用场景  
- SpinPet SDK功能验证和测试
- 快速原型开发和概念验证
- 学习和理解SDK的使用方法
- 作为更复杂交易系统的基础框架

### 典型使用流程
1. 在 `bot-global.js` 中配置代币名称、买卖数量、执行计划等
2. 运行 `node test_bot/scripts/run-all.js` 按配置执行完整流程
3. 或分步执行：先创建代币，再买入，最后卖出
4. 查看 `bot-global.js` 中自动填充的交易结果和状态数据

**关键优势**: 一次配置，多次执行；状态自动管理；执行顺序灵活可控。