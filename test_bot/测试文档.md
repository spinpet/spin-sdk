# SpinPet SDK 交易机器人测试项目设计文档

## 项目概述

本项目是一个基于 SpinPet SDK 的简化测试交易系统，功能包括创建代币、买入代币、卖出部分持仓的完整交易流程。采用简单的架构，通过全局状态管理器共享数据，各个脚本直接调用SDK执行交易。

## 项目目标

1. **创建代币**: 生成新的测试代币并部署到区块链
2. **买入交易**: 购买100,000个代币
3. **部分卖出**: 卖出50%的持仓（50,000个代币）
4. **保证金交易**: 使用1 SOL开多仓，设置10%止损
5. **状态跟踪**: 记录整个交易过程的状态和结果

## 运行测试的方法
先在 test_bot/bot-global.js  添加测试脚本(如果有就不加了)
每次都调用 node test_bot/scripts/run-plan.js 运行完整测试

## 项目架构

### 目录结构

```
test_bot/
├── 测试文档.md                  # 本文档
├── bot-global.js                # 全局状态管理器
├── sdk-factory.js               # SDK工厂：统一管理SDK实例
├── scripts/
│   ├── run-plan.js              # 主脚本：按tradingPlan执行
│   ├── create-token.js          # 单步：创建代币
│   ├── buy.js                   # 单步：买入代币
│   ├── sell.js                  # 单步：卖出代币
│   ├── long.js                  # 单步：开多仓（已实现）
│   ├── short.js                 # 单步：开空仓（已实现）
│   ├── close-long.js            # 单步：平多仓（待实现）
│   └── close-short.js           # 单步：平空仓（待实现）
└── logs/
    └── trading.log              # 交易日志
```

## 核心模块设计

### 1. SDK工厂 (sdk-factory.js)

**功能**: 统一管理SpinPet SDK实例的创建和配置，避免重复初始化

**核心特性**:
- **实例缓存**: 缓存SDK、连接和钱包实例，避免重复创建
- **自动配置**: 根据全局配置自动选择网络和钱包
- **统一接口**: 提供统一的SDK获取接口给所有交易脚本
- **连接验证**: 提供网络连接和钱包余额检查功能

**主要方法**:
```javascript
// 获取SDK实例（自动缓存）
const { sdk, connection, wallet } = SdkFactory.getSdk(options);

// 检查钱包余额
const balance = await SdkFactory.checkWalletBalance();

// 验证网络连接
const isValid = await SdkFactory.validateConnection();

// 清除缓存（配置变更时）
SdkFactory.clearCache();
```

**使用示例**:
```javascript
const SdkFactory = require('../sdk-factory');

// 在交易脚本中获取SDK
async function createToken() {
  const { sdk, connection, wallet } = SdkFactory.getSdk();
  
  // 使用SDK进行交易
  const result = await sdk.token.create({
    payer: wallet.keypair.publicKey,
    // ... 其他参数
  });
}
```

### 2. 全局状态管理器 (bot-global.js)

**功能**: 管理整个测试流程的状态数据，提供统一的数据存取接口

**主要数据结构**:
```javascript
{
  // 基础配置
  network: 'LOCALNET',           // 网络环境
  walletIndex: 0,               // 钱包索引
  
  // 代币信息
  token: {
    name: 'TestBot Token',      // 代币名称
    symbol: 'TBT',              // 代币符号
    mintAddress: null,          // 创建后的mint地址
    mintKeypair: null,          // mint密钥对（Base58编码存储）
    curveAccount: null,         // 流动池账户地址
    createdAt: null,            // 创建时间
    createTxSignature: null     // 创建交易签名
  },
  
  // 交易状态
  trading: {
    // 买入记录
    buyOrder: {
      targetAmount: '100000000000',    // 目标数量（100,000 * 10^6）
      actualAmount: null,              // 实际买入数量
      solSpent: null,                  // 花费的SOL数量
      txSignature: null,               // 交易签名
      timestamp: null,                 // 交易时间
      avgPrice: null                   // 平均价格
    },
    
    // 卖出记录
    sellOrder: {
      targetAmount: '50000000000',     // 目标数量（50,000 * 10^6）
      actualAmount: null,              // 实际卖出数量
      solReceived: null,               // 获得的SOL数量
      txSignature: null,               // 交易签名
      timestamp: null,                 // 交易时间
      avgPrice: null                   // 平均价格
    },
    
    // 余额跟踪
    balances: {
      initialSol: null,               // 初始SOL余额
      finalSol: null,                 // 最终SOL余额
      remainingTokens: null,          // 剩余代币数量
      profitLoss: null                // 盈亏计算
    }
  },
  
  // 执行状态
  execution: {
    currentStep: 'idle',              // 当前执行步骤
    completedSteps: [],               // 已完成步骤（向后兼容）
    completedStepIndexes: [],         // 已完成步骤索引列表（新增）
    errors: [],                       // 错误记录
    startTime: null,                  // 开始时间
    endTime: null                     // 结束时间
  }
}
```

**主要方法**:
- `getState()`: 获取完整状态
- `setState(path, value)`: 设置状态值
- `saveState()`: 保存状态到文件
- `loadState()`: 从文件加载状态
- `resetState()`: 重置状态
- `logMessage(level, message)`: 记录日志消息

## 执行脚本设计

### 1. 通用交易执行脚本 (scripts/run-plan.js)

**功能**: 按照`tradingPlan`配置顺序执行所有交易操作

**支持的交易类型**:
- `create-token`: 创建代币 → 调用`sdk.token.create()`
- `buy`: 现货买入 → 调用`sdk.trading.buy()`
- `sell`: 现货卖出 → 调用`sdk.trading.sell()`  
- `long`: 保证金做多 → 调用`sdk.trading.long()`
- `short`: 保证金做空 → 调用`sdk.trading.short()` ✅ **已实现**
- `closeLong`: 平多仓 → 调用`sdk.trading.closeLong()`
- `closeShort`: 平空仓 → 调用`sdk.trading.closeShort()`

**执行流程**:
1. 从`bot-global.js`加载`tradingPlan`配置
2. 遍历计划中每个启用的交易步骤
3. 根据交易类型调用对应的SDK方法
4. 记录每笔交易结果到`tradingHistory`
5. 更新持仓状态（现货余额、多空仓位）
6. 生成详细的交易报告

### 2. 单步交易脚本 (可选)

为了方便调试，也可以提供独立的脚本：

- `scripts/create-token.js`: 仅创建代币
- `scripts/buy.js`: 仅执行买入（读取配置中的买入参数）
- `scripts/sell.js`: 仅执行卖出（读取配置中的卖出参数）
- `scripts/long.js`: 仅执行开多仓
- `scripts/short.js`: 仅执行开空仓 ✅ **已实现**
- `scripts/close-long.js`: 仅执行平多仓
- `scripts/close-short.js`: 仅执行平空仓

## 配置说明

### bot-global.js 的工作原理

`bot-global.js` 包含两部分：

1. **配置部分**：用户手动配置的参数和交易计划
2. **状态部分**：脚本执行后自动填充的结果数据

```javascript
// ========== 用户配置区域 ==========
const CONFIG = {
  // 网络配置
  network: 'LOCALNET',
  walletIndex: 0,
  
  // 代币配置
  tokenInfo: {
    name: 'TestBot Token',
    symbol: 'TBT', 
    uri: 'https://example.com/testbot-token.json'
  },
  
  // 交易计划配置（支持多次交易和不同参数）
  tradingPlan: [
    // 第1轮：现货交易
    { 
      type: 'create-token', 
      enabled: true, 
      description: '创建代币',
      params: {} 
    },
    { 
      type: 'buy', 
      enabled: true, 
      description: '买入100,000个代币',
      params: {
        buyTokenAmount: '100000000000',  // 100,000 tokens (精度 10^6)
        maxSolAmount: '5000000000'       // 最多花费5 SOL
      }
    },
    { 
      type: 'sell', 
      enabled: true, 
      description: '卖出50,000个代币',
      params: {
        sellTokenAmount: '50000000000',  // 50,000 tokens
        minSolOutput: '1000000000'       // 最少得到1 SOL
      }
    },
    
    // 步骤4：做多交易（1 SOL，止损10%）
    { 
      type: 'long', 
      enabled: true, 
      description: '做多交易 1 SOL，止损 10%',
      params: {
        useSol: 1000000000,    // 使用 1 SOL (lamports)
        downPercentage: 0.1    // 止损 10%
      }
    },
    
    // 步骤5：做空交易（2 SOL，止损15%）
    { 
      type: 'short', 
      enabled: false,  // 默认禁用，可手动启用测试 
      description: '做空交易 2 SOL，止损 15%',
      params: {
        useSol: 2000000000,    // 使用 2 SOL (lamports)
        upPercentage: 0.15     // 止损 15%
      }
    },
    
    // 第2轮：再次买入
    { 
      type: 'buy', 
      enabled: true, 
      description: '再次买入30,000个代币',
      params: {
        buyTokenAmount: '30000000000',   // 30,000 tokens
        maxSolAmount: '3000000000'       // 最多花费3 SOL
      }
    },
    
    // 第3轮：保证金交易
    { 
      type: 'long', 
      enabled: true, 
      description: '开多仓位',
      params: {
        buyTokenAmount: '10000000000',   // 买入10,000个代币
        maxSolAmount: '1000000000',      // 最多花费1 SOL
        marginSol: '2000000000',         // 保证金2 SOL
        closePrice: '5000000000000000000000'  // 平仓价格
      }
    },
    { 
      type: 'short', 
      enabled: false, 
      description: '开空仓位（可选）',
      params: {
        borrowSellTokenAmount: '5000000000',  // 借出卖出5,000个代币
        minSolOutput: '100000000',            // 最少得到0.1 SOL
        marginSol: '1500000000',              // 保证金1.5 SOL
        closePrice: '3000000000000000000000'  // 平仓价格
      }
    }
  ],
  
  // 日志配置
  logFile: 'logs/trading.log'
};

// ========== 自动填充的状态数据 ==========
let STATE = {
  token: {
    mintAddress: null,
    mintKeypair: null,
    // ... 其他代币信息
  },
  
  // 交易历史记录（支持多次交易）
  tradingHistory: [],  // 每次交易都会追加到这个数组
  
  // 当前持仓状态
  positions: {
    spotBalance: '0',           // 现货余额
    longPositions: [],          // 多仓位列表
    shortPositions: []          // 空仓位列表
  },
  
  // 执行状态
  execution: {
    currentStep: 'idle',
    completedSteps: [],
    errors: []
  }
};
```

### 执行流程说明

**不是自动执行**，需要手动运行命令：

1. **配置阶段**：用户在 `bot-global.js` 中配置参数
2. **执行阶段**：运行脚本，脚本读取配置并执行交易
3. **状态更新**：脚本将执行结果写回 `bot-global.js` 的状态部分

## 使用方法

### 第一步：配置参数

在 `bot-global.js` 中配置你的测试参数：

```javascript
// 修改 CONFIG 部分的参数
const CONFIG = {
  network: 'LOCALNET',           // 选择网络
  walletIndex: 0,                // 选择钱包
  tokenInfo: {
    name: 'My Test Token',       // 自定义代币名称
    symbol: 'MTT',               // 自定义代币符号
    uri: 'https://example.com/metadata.json'
  },
  buyAmount: '50000000000',      // 修改买入数量（50,000个代币）
  sellPercentage: 0.3,           // 修改卖出比例（30%）
  
  // 自定义执行顺序
  executionPlan: [
    { step: 'create-token', enabled: true, description: '创建代币' },
    { step: 'buy-tokens', enabled: true, description: '买入代币' },
    { step: 'sell-tokens', enabled: false, description: '暂时跳过卖出' }  // 可以禁用某些步骤
  ]
};
```

### 第二步：执行命令

#### 单独执行步骤

```bash
# 创建代币
node test_bot/scripts/create-token.js

# 现货交易
node test_bot/scripts/buy.js      # 买入（使用配置中的参数）
node test_bot/scripts/sell.js     # 卖出（使用配置中的参数）

# 保证金交易
node test_bot/scripts/long.js         # 开多仓（默认1 SOL，10%止损）
node test_bot/scripts/long.js --useSol 2.5 --downPercentage 15    # 自定义参数：2.5 SOL，15%止损
node test_bot/scripts/short.js        # 开空仓（默认1 SOL，15%止损）
node test_bot/scripts/short.js --useSol 2.0 --upPercentage 20     # 自定义参数：2.0 SOL，20%止损
node test_bot/scripts/close-long.js   # 平多仓（待实现）
node test_bot/scripts/close-short.js  # 平空仓（待实现）
```

#### 根据配置执行完整流程

```bash
# 按照 tradingPlan 配置自动执行（跳过disabled的步骤）
node test_bot/scripts/run-plan.js                  # 执行完整计划
node test_bot/scripts/run-plan.js --show           # 显示当前计划
node test_bot/scripts/run-plan.js --reset          # 重置状态后执行
node test_bot/scripts/run-plan.js --continue-error # 出错时继续执行
```

#### 自定义交易计划示例

```javascript
// 在 bot-global.js 中可以这样配置不同的交易计划：

// 计划1：基础现货交易测试
tradingPlan: [
  { type: 'create-token', enabled: true, params: {} },
  { type: 'buy', enabled: true, params: { buyTokenAmount: '100000000000', maxSolAmount: '5000000000' } },
  { type: 'sell', enabled: true, params: { sellTokenAmount: '50000000000', minSolOutput: '1000000000' } }
]

// 计划2：多轮现货交易测试
tradingPlan: [
  { type: 'create-token', enabled: true, params: {} },
  { type: 'buy', enabled: true, params: { buyTokenAmount: '100000000000', maxSolAmount: '5000000000' } },
  { type: 'sell', enabled: true, params: { sellTokenAmount: '30000000000', minSolOutput: '800000000' } },
  { type: 'buy', enabled: true, params: { buyTokenAmount: '50000000000', maxSolAmount: '3000000000' } },
  { type: 'sell', enabled: true, params: { sellTokenAmount: '80000000000', minSolOutput: '2000000000' } }
]

// 计划3：保证金交易测试
tradingPlan: [
  { type: 'create-token', enabled: false, params: {} },  // 跳过创建，使用已有代币
  { type: 'long', enabled: true, params: {
      buyTokenAmount: '10000000000',
      maxSolAmount: '1000000000',
      marginSol: '2000000000',
      closePrice: '5000000000000000000000'
    }
  },
  { type: 'short', enabled: true, params: {
      borrowSellTokenAmount: '5000000000',
      minSolOutput: '100000000',
      marginSol: '1500000000',
      closePrice: '3000000000000000000000'
    }
  },
  { type: 'closeLong', enabled: true, params: {
      // closeOrder 参数会自动从 longPositions 中获取
      sellTokenAmount: '5000000000',
      minSolOutput: '500000000'
    }
  }
]

// 计划4：压力测试（大量小额交易）
tradingPlan: [
  { type: 'create-token', enabled: true, params: {} },
  ...Array(10).fill().map((_, i) => ({
    type: 'buy',
    enabled: true,
    description: `第${i+1}次买入`,
    params: { buyTokenAmount: '1000000000', maxSolAmount: '100000000' }
  })),
  ...Array(5).fill().map((_, i) => ({
    type: 'sell',
    enabled: true,
    description: `第${i+1}次卖出`,
    params: { sellTokenAmount: '1500000000', minSolOutput: '80000000' }
  }))
]
```

### 第三步：查看结果

```bash
# 显示当前计划（不执行）
node test_bot/scripts/run-plan.js --show
```

**输出示例**：
```
=== 当前交易计划 ===
网络: LOCALNET
钱包索引: 0
代币: TestBot Token (TBT)

交易步骤:
  1. [create-token] 创建测试代币 - ✅ 启用 (已完成)
  2. [buy] 买入100,000个代币 - ✅ 启用 (已完成)
  3. [sell] 卖出50,000个代币 - ✅ 启用 (已完成)
  4. [long] 做多交易 1 SOL，止损 10% - ✅ 启用 (已完成)
     useSol: 1000000000
     downPercentage: 0.1

执行命令:
  node test_bot/scripts/run-plan.js                  # 执行完整计划
  node test_bot/scripts/run-plan.js --show           # 显示当前计划
  node test_bot/scripts/run-plan.js --reset          # 重置状态后执行
  node test_bot/scripts/run-plan.js --continue-error # 出错时继续执行
```

**JavaScript状态访问**：
```javascript
// 执行后查看状态
const BotGlobal = require('../bot-global');
const state = BotGlobal.getState();

// 查看交易历史
console.log('交易历史:', state.state.tradingHistory);

// 查看当前持仓
console.log('现货余额:', state.state.positions.spotBalance);
console.log('多仓位置:', state.state.positions.longPositions);
console.log('空仓位置:', state.state.positions.shortPositions);

// 查看完整状态
console.log('完整状态:', JSON.stringify(state, null, 2));
```

## 错误处理

### 错误类型
1. **网络连接错误**: Solana网络连接失败
2. **钱包余额不足**: SOL余额不足以支付交易费用
3. **交易失败**: 区块链交易执行失败
4. **流动性不足**: 买卖时流动性不够
5. **状态不一致**: 步骤之间状态传递错误

### 错误恢复
- 自动重试机制
- 状态回滚功能
- 详细错误日志
- 手动恢复指导

## 监控和日志

### 交易监控
- 实时余额跟踪
- 交易状态监控
- 价格变化跟踪
- Gas费用统计

### 日志系统
- 结构化日志记录
- 多级别日志（debug, info, warn, error）
- 文件和控制台双输出
- 交易历史保存

## 扩展功能

## Long功能测试结果

基于SpinPet SDK的long功能测试已成功实现，测试结果如下：

### 测试执行记录

```
=== 最终执行结果 ===
成功: true
总用时: 7.80 秒
成功步骤: 4
失败步骤: 0
跳过步骤: 0

=== 交易历史 ===
1. [create-token] 创建代币 TestBot Token (TBT) - completed
   交易签名: 2f8hhARihDU6FZm5gUsebDu9KhkywPGpT4zhHAs8ZsMTGsjyxEteiaibiaWvWqynbEi6eoct6TTYQLxeQZSpH5q2
2. [buy] 买入 300000000 个代币 - completed
   交易签名: 4o3jqo17ihHFCjVkoVe1DHPmCLBeb1qcyV5YYfmqXU77jBsaXi8VjHJWM5axbjoX8HTwe6qrwnvpCLWphzgur7H7
3. [sell] 卖出 5000.00 个代币 - completed
   交易签名: YzKpBfDYci9ZThgDmgLgtNoNtPFzj7XPXgjmPGXsYcyzWsroC6ntU76QjfGMVasMTeoH2Z2ps5TWoKQL4UYEoeP
4. [long] 做多 18127496 个代币，止损 10.0% - completed
   交易签名: 5UY6AhMu3Bqo1CCQgX8jDsf1Rt5NGrL6JWJS9VXd2GV4Hra4xsTf5A8nMqmAU2haHrVCuqXxnCDcEWk5F4NaohZG

=== 持仓状态 ===
现货余额: 299995000000000
多仓位置: 1 个
空仓位置: 0 个
```

### Long交易详细信息

**交易参数**：
- 使用SOL：1.0000 SOL
- 止损百分比：10.0%
- 买入代币数量：18127496 个
- 最大SOL花费：2.0000 SOL
- 保证金：5.0000 SOL
- 平仓价格：484840488362747153285

**模拟结果**：
- 止损模拟成功，可执行止损价格：484840488362747153285
- 杠杆倍数：10.00x
- 预期SOL输出：0.859767 SOL
- 价格调整次数：1次

**实际交易结果**：
- 订单PDA：6vypETH7uac4BhyvkfgxGvsyAPvGfFkDinnTkvtzkD4q
- 实际花费SOL：0.165047 SOL
- 交易用时：0.44秒
- 交易状态：成功完成

### Long功能特性验证

✅ **自动参数生成**：根据useSol和downPercentage自动计算买入代币数量和止损价格  
✅ **流动性模拟**：买入前验证流动性，避免超出市场承载能力  
✅ **止损模拟器**：自动调整止损价格避免与现有订单冲突  
✅ **订单链表定位**：正确计算订单在链表中的前后节点关系  
✅ **状态管理**：完整记录多仓位信息到全局状态  
✅ **SDK集成**：与SpinPet SDK完全兼容，使用标准接口  

## Short功能实现状态

✅ **短交易脚本已实现**：`test_bot/scripts/short.js` 已完成开发  
✅ **自动参数生成**：支持根据 `useSol` 和 `upPercentage` 自动计算做空参数  
✅ **独立可执行**：可以独立运行或通过 `run-plan.js` 配置执行  
✅ **参数验证**：包含完整的流动性模拟和止损价格计算  
✅ **止损模拟器**：使用 `simulateSellStopLoss` 计算止损价格和订单链表位置  
📝 **待测试**：需要在实际环境中验证功能完整性  

## 最新更新亮点

### 🆕 执行状态管理优化
- **步骤索引跟踪**：新增 `completedStepIndexes` 字段，支持多次相同类型交易的准确跟踪
- **向后兼容**：保留原有 `completedSteps` 字段，确保现有代码正常工作  
- **精确续执行**：基于步骤索引而非交易类型判断完成状态，支持复杂交易计划

### 🎯 交易参数升级
- **数量精度提升**：买入代币数量从 `1000000000` 升级到 `300000000000000`，支持大额交易测试
- **SOL限制调整**：最大SOL花费从 `5000000000` 调整为 `50000000000`，匹配大额交易需求
- **卖出数量优化**：卖出代币数量从 `500000000` 调整为 `5000000000`，维持合理比例

### ⚡ 执行流程完善  
- **错误处理增强**：执行失败时正确记录步骤索引和错误信息
- **状态同步改进**：交易完成后立即更新执行状态，避免状态滞后
- **多轮交易支持**：完善对多次相同类型交易的支持（如多次long交易）

## 总结

这个简化的测试项目采用"配置驱动"的设计：

### 工作原理
1. **配置阶段**: 用户在 `bot-global.js` 中配置测试参数（代币信息、交易数量、执行顺序等）
2. **执行阶段**: 手动运行脚本命令，脚本读取配置并调用SpinPet SDK执行交易
3. **状态更新**: 脚本自动将执行结果（交易签名、余额等）写回 `bot-global.js`
4. **结果查看**: 所有交易数据和状态都保存在 `bot-global.js` 中，可随时查看

### 核心特点
1. **简单结构**: 只有全局状态管理器和6个脚本文件（含long、short）
2. **配置驱动**: 通过修改配置控制测试行为，无需修改代码
3. **执行顺序可控**: 可自定义哪些步骤执行、哪些跳过
4. **状态持久化**: 测试数据自动保存，支持断点续执行
5. **直接调用**: 脚本直接调用SpinPet SDK，无额外封装
6. **保证金交易完整**: 支持做多和做空操作，参数自动生成

### 适用场景  
- SpinPet SDK功能验证和测试
- 快速原型开发和概念验证
- 学习和理解SDK的使用方法
- 作为更复杂交易系统的基础框架

### 典型使用场景

#### 1. 基础功能测试
配置简单的创建→买入→卖出流程，验证SDK基础功能

#### 2. 多轮交易测试  
配置多次买卖操作，测试连续交易和余额管理

#### 3. 保证金交易测试
配置long/short开仓和平仓操作，测试杠杆交易功能

#### 4. 混合策略测试
结合现货和保证金交易，测试复杂交易策略

#### 5. 压力测试
配置大量小额交易，测试系统稳定性和性能

### 执行流程
1. 在 `bot-global.js` 中配置 `tradingPlan`（交易类型、参数、启用状态）
2. 运行 `node test_bot/scripts/run-plan.js` 按配置执行完整流程
3. 或分步执行：先创建代币，再执行各种交易类型
4. 查看 `bot-global.js` 中自动填充的交易历史和持仓状态

**关键优势**: 
- 支持7种交易类型（创建、买、卖、开多、开空、平多、平空）
- **已实现5种**：create-token、buy、sell、long、short ✅
- **待实现2种**：close-long、close-short 📝
- 一次配置，多次执行
- 多轮交易和不同参数测试
- 状态自动管理和持仓跟踪
- 执行顺序灵活可控
- 智能参数生成（long: useSol+downPercentage, short: useSol+upPercentage）